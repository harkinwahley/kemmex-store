<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KEMMEX STORE - Your Journey, Our Fashion</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap">

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Your web app's Firebase configuration (provided by user)
        let firebaseConfig = {
            apiKey: "AIzaSyDZDhAOl1JbQoPqUORB2QfqWgYUIfFGXbA",
            authDomain: "kemmex-store.firebaseapp.com",
            projectId: "kemmex-store",
            storageBucket: "kemmex-store.firebasestorage.app",
            messagingSenderId: "652069351107",
            appId: "1:652069351107:web:9760a3ba825d296f7efc76"
        };

        // Global variables provided by Canvas environment (override if available)
        let appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        if (typeof _firebase_config !== 'undefined' && Object.keys(JSON.parse(_firebase_config)).length > 0) {
            firebaseConfig = JSON.parse(_firebase_config);
        }
        let initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app;
        let db;
        let auth;
        let currentUserId = null;
        let authReadyPromiseResolver;
        let authReadyPromise = new Promise(resolve => {
            authReadyPromiseResolver = resolve;
        });

        // Initialize Firebase and set up auth listener
        const initFirebase = async () => {
            try {
                if (Object.keys(firebaseConfig).length > 0) {
                    app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    auth = getAuth(app);

                    onAuthStateChanged(auth, async (user) => {
                        currentUserId = user ? user.uid : null;
                        if (user) {
                            console.log("Authenticated user:", currentUserId);
                            // Load cart for the authenticated user
                            await loadCart(currentUserId);
                        } else {
                            console.log("No user authenticated.");
                            if (initialAuthToken) {
                                try {
                                    await signInWithCustomToken(auth, initialAuthToken);
                                    console.log("Signed in with custom token.");
                                } catch (error) {
                                    console.error("Error signing in with custom token:", error);
                                    await signInAnonymously(auth);
                                    console.log("Signed in anonymously due to custom token error.");
                                }
                            } else {
                                await signInAnonymously(auth);
                                console.log("Signed in anonymously.");
                            }
                            // Clear cart if no user or anonymous user
                            await loadCart(currentUserId);
                        }
                        authReadyPromiseResolver(true);
                    });

                    // Initial anonymous sign-in if no current user and no token
                    if (!auth.currentUser && !initialAuthToken) {
                        await signInAnonymously(auth);
                        console.log("Initial anonymous sign-in triggered.");
                    }

                } else {
                    console.error("Firebase config is empty. Cannot initialize Firebase.");
                    authReadyPromiseResolver(false);
                }
            } catch (error) {
                console.error("Error initializing Firebase:", error);
                authReadyPromiseResolver(false);
            }
        };

        initFirebase();

        // Expose globals for easier access in the main script block
        window.appId = appId;
        window.db = db;
        window.auth = auth;
        window.getAuth = getAuth;
        window.signInAnonymously = signInAnonymously;
        window.createUserWithEmailAndPassword = createUserWithEmailAndPassword;
        window.signInWithEmailAndPassword = signInWithEmailAndPassword;
        window.signOut = signOut;
        window.getFirestore = getFirestore;
        window.doc = doc;
        window.getDoc = getDoc;
        window.addDoc = addDoc;
        window.setDoc = setDoc;
        window.updateDoc = updateDoc;
        window.deleteDoc = deleteDoc;
        window.onSnapshot = onSnapshot;
        window.collection = collection;
        window.query = query;
        window.where = where;
        window.getDocs = getDocs;
        window.writeBatch = writeBatch; // Expose writeBatch
        
        // Pass currentUserId via a getter
        Object.defineProperty(window, 'currentUserId', {
            get: () => auth ? auth.currentUser?.uid : null
        });

        // Ensure authReadyPromise is available globally before other scripts try to use Firebase
        window.authReadyPromise = authReadyPromise;
    </script>

    <style>
        /* Custom Colors & Fonts (Derived from Kemmex Store image) */
        :root {
            --color-primary-pink: #D02B62; /* Deep Pink */
            --color-accent-orange: #FF8C00; /* Vibrant Orange */
            --color-background-light: #FDFDFD; /* Off-white */
            --color-background-header: #FFECEF; /* Lighter Pink Hue for Header */
            --color-text-dark: #222222; /* Dark Grey */
            --color-text-light: #FFFFFF; /* White */
        }

        body {
            font-family: 'Inter', sans-serif;
            color: var(--color-text-dark);
            background-color: var(--color-background-light);
        }

        .bg-primary-pink { background-color: var(--color-primary-pink); }
        .bg-accent-orange { background-color: var(--color-accent-orange); }
        .bg-background-light { background-color: var(--color-background-light); }
        .bg-background-header { background-color: var(--color-background-header); }
        .text-primary-pink { color: var(--color-primary-pink); }
        .text-accent-orange { color: var(--color-accent-orange); }
        .text-text-dark { color: var(--color-text-dark); }
        .text-text-light { color: var(--color-text-light); }
        .border-primary-pink { border-color: var(--color-primary-pink); }
        .focus-ring-primary-pink:focus {
            outline: 2px solid var(--color-primary-pink);
            outline-offset: 2px;
        }

        .btn-main {
            background-color: var(--color-primary-pink);
            color: var(--color-text-light);
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .btn-main:hover {
            background-color: var(--color-accent-orange);
            box-shadow: 0 6px 8px rgba(0, 0, 0, 0.15);
        }
        .btn-outline-main {
            border: 2px solid var(--color-primary-pink);
            color: var(--color-primary-pink);
            background-color: transparent;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        .btn-outline-main:hover {
            background-color: var(--color-primary-pink);
            color: var(--color-text-light);
        }

        .product-card {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            cursor: pointer;
        }
        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
        }

        /* Modal styling */
        .modal {
            background-color: rgba(0,0,0,0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1000;
            overflow-y: auto; /* Allow scrolling for tall modals */
            padding: 1rem;
        }
        .modal-content {
            background-color: var(--color-background-light);
            padding: 2rem;
            border-radius: 1rem;
            max-width: 90%;
            min-width: 320px;
            width: auto;
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
            position: relative;
            max-height: 90vh; /* Max height to prevent overflow on small screens */
            overflow-y: auto; /* Make modal content scrollable */
        }
        .modal-close-btn {
            position: absolute;
            top: 1rem;
            right: 1rem;
            font-size: 1.8rem;
            cursor: pointer;
            color: var(--color-text-dark);
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <header class="bg-background-header text-text-dark p-4 shadow-md sticky top-0 z-50">
        <div class="container mx-auto flex justify-between items-center">
            <a href="#" id="homeLink" class="text-3xl font-extrabold tracking-tight text-primary-pink">KEMMEX STORE</a>
            <nav class="flex items-center space-x-4">
                <a href="#" id="viewCartBtn" class="text-text-dark hover:text-primary-pink relative text-lg font-medium">
                    Cart
                    <span id="cartItemCount" class="absolute -top-3 -right-3 bg-accent-orange text-white text-xs font-bold rounded-full h-6 w-6 flex items-center justify-center">0</span>
                </a>
                <button id="loginSignupBtn" class="btn-main text-base px-5 py-2">Login / Signup</button>
                <button id="logoutBtn" class="btn-outline-main text-base px-5 py-2 hidden">Logout</button>
            </nav>
        </div>
    </header>

    <main class="flex-grow container mx-auto p-4 py-8">

        <div id="initialLoader" class="flex flex-col items-center justify-center h-64">
            <div class="animate-spin rounded-full h-20 w-20 border-t-4 border-b-4 border-primary-pink"></div>
            <p class="mt-4 text-2xl text-accent-orange font-semibold">Loading KEMMEX STORE...</p>
            <p id="authStatus" class="mt-2 text-base text-gray-500"></p>
        </div>

        <section id="productListing" class="hidden">
            <h2 class="text-4xl font-bold mb-8 text-center text-primary-pink">Our Chic Collections</h2>

            <div class="flex flex-wrap justify-center gap-3 mb-10">
                <button class="category-btn btn-main px-5 py-2 text-base rounded-full" data-category="all">All Items</button>
                <button class="category-btn btn-outline-main px-5 py-2 text-base rounded-full" data-category="Baby Fashion">Baby Fashion</button>
                <button class="category-btn btn-outline-main px-5 py-2 text-base rounded-full" data-category="Kids Fashion">Kids Fashion</button>
                <button class="category-btn btn-outline-main px-5 py-2 text-base rounded-full" data-category="Adult Female Fashion">Adult Female Fashion</button>
                <button class="category-btn btn-outline-main px-5 py-2 text-base rounded-full" data-category="Maternity Wear">Maternity Wear</button>
                <button class="category-btn btn-outline-main px-5 py-2 text-base rounded-full" data-category="Nursing Wear">Nursing Wear</button>
                <button class="category-btn btn-outline-main px-5 py-2 text-base rounded-full" data-category="Hospital Kits">Hospital Kits</button>
            </div>

            <div id="productsGrid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-8">
            </div>
            <div id="noProductsMessage" class="text-center text-accent-orange text-xl mt-12 hidden font-semibold">No products found in this category.</div>
        </section>

        <div id="productDetailModal" class="modal hidden">
            <div class="modal-content">
                <span class="modal-close-btn">&times;</span>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 items-start">
                    <div>
                        <img id="detailImg" src="" alt="Product Image" class="w-full h-auto max-h-96 object-contain rounded-lg shadow-md mb-4 bg-gray-100">
                    </div>
                    <div>
                        <h3 id="detailName" class="text-3xl font-bold mb-2 text-primary-pink"></h3>
                        <p id="detailPrice" class="text-2xl font-bold text-accent-orange mb-3"></p>
                        <p id="detailCategory" class="text-sm text-gray-500 mb-2"></p>
                        <p id="detailDescription" class="text-gray-700 mb-4 text-justify"></p>
                        <p id="detailAvailability" class="text-base text-gray-600 mb-4 font-medium"></p>
                        <div class="flex items-center space-x-4 mb-6">
                            <label for="detailQuantity" class="text-lg font-semibold">Quantity:</label>
                            <input type="number" id="detailQuantity" value="1" min="1" class="w-24 p-2 border border-primary-pink rounded-md text-center focus-ring-primary-pink text-lg">
                        </div>
                        <button id="addToCartBtn" class="btn-main w-full py-3 text-xl">Add to Cart</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="cartModal" class="modal hidden">
            <div class="modal-content">
                <span class="modal-close-btn">&times;</span>
                <h3 class="text-3xl font-bold mb-6 text-center text-primary-pink">Your Shopping Cart</h3>
                <div id="cartItemsContainer" class="max-h-96 overflow-y-auto pr-3 mb-6 space-y-4">
                </div>
                <div id="cartSummary" class="border-t-2 border-primary-pink pt-6 mt-6">
                    <p class="text-2xl font-bold flex justify-between mb-4">Total: <span id="cartTotal" class="text-accent-orange">₦0.00</span></p>
                    <button id="checkoutBtn" class="btn-main w-full py-3 text-xl">Proceed to Checkout</button>
                    <button id="clearCartBtn" class="btn-outline-main w-full py-3 text-lg mt-3">Clear Cart</button>
                </div>
                <div id="emptyCartMessage" class="text-center text-accent-orange text-xl mt-6 hidden font-semibold">Your cart is empty. Start shopping!</div>
            </div>
        </div>

        <div id="checkoutModal" class="modal hidden">
            <div class="modal-content">
                <span class="modal-close-btn">&times;</span>
                <h3 class="text-3xl font-bold mb-6 text-center text-primary-pink">Complete Your Order</h3>
                <form id="checkoutForm">
                    <div class="mb-5">
                        <label for="customerName" class="block text-text-dark text-sm font-bold mb-2">Full Name:</label>
                        <input type="text" id="customerName" class="shadow-sm appearance-none border border-gray-300 rounded w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus-ring-primary-pink" required>
                    </div>
                    <div class="mb-5">
                        <label for="customerAddress" class="block text-text-dark text-sm font-bold mb-2">Delivery Address:</label>
                        <textarea id="customerAddress" rows="4" class="shadow-sm appearance-none border border-gray-300 rounded w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus-ring-primary-pink" required></textarea>
                    </div>
                    <div class="mb-6">
                        <label class="block text-text-dark text-sm font-bold mb-3">Payment Method:</label>
                        <div class="flex flex-col space-y-3">
                            <label class="inline-flex items-center text-lg">
                                <input type="radio" id="payOnline" name="paymentMethod" value="Online" class="form-radio h-5 w-5 text-primary-pink border-primary-pink" checked>
                                <span class="ml-2">Pay Online (Simulated)</span>
                            </label>
                            <label class="inline-flex items-center text-lg">
                                <input type="radio" id="payOnDelivery" name="paymentMethod" value="Pay on Delivery" class="form-radio h-5 w-5 text-primary-pink border-primary-pink">
                                <span class="ml-2">Pay on Delivery</span>
                            </label>
                        </div>
                    </div>
                    <p class="text-2xl font-bold text-right mb-6">Total: <span id="checkoutTotal" class="text-accent-orange">₦0.00</span></p>
                    <button type="submit" class="btn-main w-full py-3 text-xl">Place Order</button>
                </form>
                <div id="checkoutMessage" class="text-center mt-6 text-xl hidden font-semibold"></div>
            </div>
        </div>

        <div id="authModal" class="modal hidden">
            <div class="modal-content">
                <span class="modal-close-btn">&times;</span>
                <h3 id="authModalTitle" class="text-3xl font-bold mb-6 text-center text-primary-pink">Login</h3>
                <form id="authForm">
                    <div class="mb-5">
                        <label for="authEmail" class="block text-text-dark text-sm font-bold mb-2">Email:</label>
                        <input type="email" id="authEmail" class="shadow-sm appearance-none border border-gray-300 rounded w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus-ring-primary-pink" required>
                    </div>
                    <div class="mb-6">
                        <label for="authPassword" class="block text-text-dark text-sm font-bold mb-2">Password:</label>
                        <input type="password" id="authPassword" class="shadow-sm appearance-none border border-gray-300 rounded w-full py-3 px-4 text-gray-700 mb-3 leading-tight focus:outline-none focus-ring-primary-pink" required>
                    </div>
                    <div id="authError" class="text-red-600 text-sm text-center mb-4 hidden font-medium"></div>
                    <button type="submit" id="authSubmitBtn" class="btn-main w-full py-3 text-xl">Login</button>
                </form>
                <p class="text-center text-base mt-6">
                    <button id="toggleAuthModeBtn" class="text-primary-pink hover:underline font-medium">Don't have an account? Sign up</button>
                </p>
            </div>
        </div>

    </main>

    <footer class="bg-background-header text-text-dark p-6 mt-12 shadow-inner">
        <div class="container mx-auto text-center text-sm font-medium">
            &copy; 2025 KEMMEX STORE. All rights reserved.
        </div>
    </footer>

    <script>
        // === GLOBAL REFERENCES & VARIABLES ===
        let productsRef;
        let cartRef;
        let ordersRef;

        let allProducts = [];
        let shoppingCart = []; // Local representation of the cart
        let authMode = 'login'; // 'login' or 'signup'

        // DOM elements
        const initialLoader = document.getElementById('initialLoader');
        const authStatus = document.getElementById('authStatus');
        const productListingSection = document.getElementById('productListing');
        const productsGrid = document.getElementById('productsGrid');
        const noProductsMessage = document.getElementById('noProductsMessage');
        const cartItemCount = document.getElementById('cartItemCount');
        const loginSignupBtn = document.getElementById('loginSignupBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const viewCartBtn = document.getElementById('viewCartBtn');
        const homeLink = document.getElementById('homeLink');

        // Modals
        const productDetailModal = document.getElementById('productDetailModal');
        const cartModal = document.getElementById('cartModal');
        const checkoutModal = document.getElementById('checkoutModal');
        const authModal = document.getElementById('authModal');

        // Modal Close Buttons
        document.querySelectorAll('.modal-close-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                productDetailModal.classList.add('hidden');
                cartModal.classList.add('hidden');
                checkoutModal.classList.add('hidden');
                authModal.classList.add('hidden');
            });
        });

        // Product Detail Modal Elements
        const detailImg = document.getElementById('detailImg');
        const detailName = document.getElementById('detailName');
        const detailPrice = document.getElementById('detailPrice');
        const detailCategory = document.getElementById('detailCategory');
        const detailDescription = document.getElementById('detailDescription');
        const detailAvailability = document.getElementById('detailAvailability');
        const detailQuantity = document.getElementById('detailQuantity');
        const addToCartBtn = document.getElementById('addToCartBtn');

        let currentSelectedProduct = null; // To hold the product object clicked

        // Cart Modal Elements
        const cartItemsContainer = document.getElementById('cartItemsContainer');
        const cartTotal = document.getElementById('cartTotal');
        const checkoutBtn = document.getElementById('checkoutBtn');
        const clearCartBtn = document.getElementById('clearCartBtn');
        const emptyCartMessage = document.getElementById('emptyCartMessage');

        // Checkout Modal Elements
        const checkoutForm = document.getElementById('checkoutForm');
        const customerName = document.getElementById('customerName');
        const customerAddress = document.getElementById('customerAddress');
        const checkoutTotal = document.getElementById('checkoutTotal');
        const checkoutMessage = document.getElementById('checkoutMessage');

        // Auth Modal Elements
        const authModalTitle = document.getElementById('authModalTitle');
        const authForm = document.getElementById('authForm');
        const authEmail = document.getElementById('authEmail');
        const authPassword = document.getElementById('authPassword');
        const authError = document.getElementById('authError');
        const authSubmitBtn = document.getElementById('authSubmitBtn');
        const toggleAuthModeBtn = document.getElementById('toggleAuthModeBtn');

        // === FIREBASE & DATA INITIALIZATION ===

        // Function to initialize Firestore references
        const setupFirebaseRefs = () => {
            if (window.db) { // Use window.db from the module script
                productsRef = window.collection(window.db, 'products');
                // Cart collection will be per user, defined in loadCart
                ordersRef = window.collection(window.db, 'orders'); // Global orders collection
            } else {
                console.error("Firestore not initialized. Cannot set up references.");
            }
        };

        // Fetch Products from Firestore
        const fetchProducts = async () => {
            if (!productsRef) {
                console.error("Products reference not set up. Retrying setup...");
                setupFirebaseRefs(); // Try setting up refs again
                if (!productsRef) return; // If still not set, give up
            }
            try {
                const q = window.query(productsRef);
                const querySnapshot = await window.getDocs(q);
                allProducts = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                displayProducts(allProducts);
            } catch (error) {
                console.error("Error fetching products:", error);
                productsGrid.innerHTML = `<p class="text-red-500 text-center col-span-full">Error loading products. Please try again.</p>`;
            }
        };

        // Load or initialize user's cart from Firestore
        const loadCart = async (userId) => {
            if (!userId || !window.db) {
                console.log("No user or db to load cart. Setting anonymous cart.");
                shoppingCart = []; // Clear local cart if no user
                updateCartUI();
                return;
            }

            // Reference to user's specific cart document in the 'carts' collection
            cartRef = window.doc(window.db, 'carts', userId); 

            try {
                const cartDoc = await window.getDoc(cartRef);
                if (cartDoc.exists()) {
                    shoppingCart = cartDoc.data().items || [];
                    console.log("Cart loaded:", shoppingCart);
                } else {
                    console.log("No cart found for user, initializing empty cart.");
                    shoppingCart = [];
                    await window.setDoc(cartRef, { items: [] }, { merge: true }); // Create empty cart doc
                }
            } catch (error) {
                console.error("Error loading cart:", error);
                shoppingCart = []; // Fallback to empty cart on error
            } finally {
                updateCartUI();
            }
        };

        // Save cart to Firestore
        const saveCart = async () => {
            if (window.currentUserId && cartRef) {
                try {
                    await window.setDoc(cartRef, { items: shoppingCart }, { merge: true });
                    console.log("Cart saved to Firestore.");
                } catch (error) {
                    console.error("Error saving cart to Firestore:", error);
                }
            } else {
                console.warn("Cannot save cart: No authenticated user or cartRef not set.");
            }
        };

        // === UI RENDERING ===

        // Display Products in the Grid
        const displayProducts = (productsToDisplay) => {
            productsGrid.innerHTML = '';
            if (productsToDisplay.length === 0) {
                noProductsMessage.classList.remove('hidden');
                return;
            }
            noProductsMessage.classList.add('hidden');

            productsToDisplay.forEach(product => {
                const productCard = document.createElement('div');
                productCard.className = 'product-card bg-white rounded-lg shadow-lg overflow-hidden flex flex-col justify-between';
                productCard.innerHTML = `
                    <img src="${product.imageUrl || 'https://via.placeholder.com/400x300?text=Product+Image'}" alt="${product.name}" class="w-full h-48 object-cover">
                    <div class="p-5 flex-grow flex flex-col">
                        <h3 class="text-xl font-semibold mb-2 text-text-dark">${product.name}</h3>
                        <p class="text-primary-pink font-medium text-sm mb-2">${product.category}</p>
                        <p class="text-2xl font-bold text-accent-orange mb-3">₦${product.price ? product.price.toLocaleString() : 'N/A'}</p>
                        <p class="text-gray-600 text-sm mb-4 line-clamp-2">${product.description || 'No description available.'}</p>
                        <button class="btn-main mt-auto add-to-cart-quick-btn" data-product-id="${product.id}">Add to Cart</button>
                    </div>
                `;
                productCard.querySelector('.add-to-cart-quick-btn').addEventListener('click', (e) => {
                    e.stopPropagation(); // Prevent opening detail modal
                    addToCart(product, 1); // Add one quantity directly
                });
                productCard.addEventListener('click', () => openProductDetailModal(product));
                productsGrid.appendChild(productCard);
            });
        };

        // Update Cart UI
        const updateCartUI = () => {
            cartItemsContainer.innerHTML = '';
            let total = 0;

            if (shoppingCart.length === 0) {
                emptyCartMessage.classList.remove('hidden');
                cartSummary.classList.add('hidden');
            } else {
                emptyCartMessage.classList.add('hidden');
                cartSummary.classList.remove('hidden');
                shoppingCart.forEach(item => {
                    const itemTotal = item.price * item.quantity;
                    total += itemTotal;
                    const cartItemDiv = document.createElement('div');
                    cartItemDiv.className = 'flex items-center justify-between p-3 border border-gray-200 rounded-lg shadow-sm';
                    cartItemDiv.innerHTML = `
                        <div class="flex items-center flex-grow">
                            <img src="${item.imageUrl || 'https://via.placeholder.com/50'}" alt="${item.name}" class="w-16 h-16 object-cover rounded-md mr-4">
                            <div>
                                <h4 class="font-semibold text-lg text-text-dark">${item.name}</h4>
                                <p class="text-primary-pink text-base">₦${item.price.toLocaleString()} x ${item.quantity}</p>
                            </div>
                        </div>
                        <div class="flex items-center space-x-2">
                            <button class="text-primary-pink hover:text-accent-orange text-2xl font-bold p-1 remove-from-cart-btn" data-product-id="${item.id}">&ndash;</button>
                            <span class="text-lg font-bold">₦${itemTotal.toLocaleString()}</span>
                            <button class="text-primary-pink hover:text-accent-orange text-2xl font-bold p-1 add-one-to-cart-btn" data-product-id="${item.id}">+</button>
                            <button class="ml-4 text-red-500 hover:text-red-700 font-bold text-xl delete-item-btn" data-product-id="${item.id}">&#10005;</button>
                        </div>
                    `;
                    cartItemsContainer.appendChild(cartItemDiv);
                });
            }

            cartTotal.textContent = `₦${total.toLocaleString()}`;
            checkoutTotal.textContent = `₦${total.toLocaleString()}`;
            cartItemCount.textContent = shoppingCart.reduce((sum, item) => sum + item.quantity, 0);

            // Add event listeners for cart item buttons
            document.querySelectorAll('.remove-from-cart-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const productId = e.currentTarget.dataset.productId;
                    const item = shoppingCart.find(i => i.id === productId);
                    if (item && item.quantity > 1) {
                        item.quantity--;
                    } else if (item && item.quantity === 1) {
                        shoppingCart = shoppingCart.filter(i => i.id !== productId);
                    }
                    saveCart();
                    updateCartUI();
                });
            });

            document.querySelectorAll('.add-one-to-cart-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const productId = e.currentTarget.dataset.productId;
                    const item = shoppingCart.find(i => i.id === productId);
                    if (item) {
                        item.quantity++;
                    }
                    saveCart();
                    updateCartUI();
                });
            });

            document.querySelectorAll('.delete-item-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const productId = e.currentTarget.dataset.productId;
                    shoppingCart = shoppingCart.filter(item => item.id !== productId);
                    saveCart();
                    updateCartUI();
                });
            });
        };

        // === MODAL FUNCTIONS ===

        const openProductDetailModal = (product) => {
            currentSelectedProduct = product;
            detailImg.src = product.imageUrl || 'https://via.placeholder.com/400x300?text=Product+Image';
            detailName.textContent = product.name;
            detailPrice.textContent = `₦${product.price ? product.price.toLocaleString() : 'N/A'}`;
            detailCategory.textContent = `Category: ${product.category}`;
            detailDescription.textContent = product.description || 'No description available for this product.';
            detailAvailability.textContent = product.isAvailable ? 'In Stock' : 'Out of Stock';
            detailAvailability.className = `text-base mb-4 font-medium ${product.isAvailable ? 'text-green-600' : 'text-red-600'}`;
            detailQuantity.value = 1; // Reset quantity
            addToCartBtn.disabled = !product.isAvailable;
            addToCartBtn.textContent = product.isAvailable ? 'Add to Cart' : 'Out of Stock';

            productDetailModal.classList.remove('hidden');
        };

        const addToCart = (product, quantity) => {
            const existingItemIndex = shoppingCart.findIndex(item => item.id === product.id);

            if (existingItemIndex > -1) {
                shoppingCart[existingItemIndex].quantity += quantity;
            } else {
                shoppingCart.push({
                    id: product.id,
                    name: product.name,
                    price: product.price,
                    imageUrl: product.imageUrl,
                    quantity: quantity
                });
            }
            saveCart();
            updateCartUI();
            alert(`${quantity} of "${product.name}" added to cart!`); // Simple feedback
        };

        const openCartModal = () => {
            updateCartUI(); // Ensure cart UI is up-to-date
            cartModal.classList.remove('hidden');
        };

        const openCheckoutModal = () => {
            if (shoppingCart.length === 0) {
                alert('Your cart is empty. Please add items before checking out.');
                return;
            }
            cartModal.classList.add('hidden'); // Close cart modal
            checkoutTotal.textContent = `₦${shoppingCart.reduce((sum, item) => sum + item.price * item.quantity, 0).toLocaleString()}`;
            checkoutMessage.classList.add('hidden'); // Hide any previous messages
            checkoutModal.classList.remove('hidden');
        };

        const openAuthModal = (mode = 'login') => {
            authMode = mode;
            authModalTitle.textContent = authMode === 'login' ? 'Login' : 'Sign Up';
            authSubmitBtn.textContent = authMode === 'login' ? 'Login' : 'Sign Up';
            toggleAuthModeBtn.textContent = authMode === 'login' ? "Don't have an account? Sign up" : "Already have an account? Login";
            authError.classList.add('hidden');
            authEmail.value = '';
            authPassword.value = '';
            authModal.classList.remove('hidden');
        };

        // === EVENT LISTENERS ===

        document.addEventListener('DOMContentLoaded', async () => {
            // Wait for Firebase to be initialized and authenticated
            authStatus.textContent = "Initializing authentication...";
            await window.authReadyPromise; // Use the global promise

            if (!window.auth) {
                authStatus.textContent = "Firebase failed to initialize. Please check config.";
                return;
            }
            authStatus.textContent = "Loading products...";
            setupFirebaseRefs();
            await fetchProducts(); // Fetch products once Firebase is ready and refs are set up

            initialLoader.classList.add('hidden');
            productListingSection.classList.remove('hidden');
            updateAuthStateUI(window.auth.currentUser); // Initial UI update based on auth state
        });

        // Listen for Auth State Changes to update UI and cart
        window.auth.onAuthStateChanged((user) => {
            updateAuthStateUI(user);
            loadCart(user ? user.uid : null); // Load cart specific to the user
        });

        // Category filtering
        document.querySelectorAll('.category-btn').forEach(button => {
            button.addEventListener('click', (e) => {
                const selectedCategory = e.target.dataset.category;
                document.querySelectorAll('.category-btn').forEach(btn => {
                    btn.classList.remove('btn-main');
                    btn.classList.add('btn-outline-main');
                });
                e.target.classList.remove('btn-outline-main');
                e.target.classList.add('btn-main');

                let filteredProducts = [];
                if (selectedCategory === 'all') {
                    filteredProducts = allProducts;
                } else {
                    filteredProducts = allProducts.filter(product => product.category === selectedCategory);
                }
                displayProducts(filteredProducts);
            });
        });

        addToCartBtn.addEventListener('click', () => {
            if (currentSelectedProduct) {
                const quantity = parseInt(detailQuantity.value);
                if (quantity > 0) {
                    addToCart(currentSelectedProduct, quantity);
                    productDetailModal.classList.add('hidden'); // Close modal after adding to cart
                } else {
                    alert('Please enter a valid quantity.');
                }
            }
        });

        viewCartBtn.addEventListener('click', openCartModal);
        clearCartBtn.addEventListener('click', () => {
            if (confirm('Are you sure you want to clear your entire cart?')) {
                shoppingCart = [];
                saveCart();
                updateCartUI();
            }
        });
        checkoutBtn.addEventListener('click', openCheckoutModal);

        checkoutForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            checkoutMessage.classList.remove('hidden', 'text-green-600', 'text-red-600');
            checkoutMessage.classList.add('text-gray-700');
            checkoutMessage.textContent = 'Processing order...';

            if (!window.currentUserId) {
                checkoutMessage.classList.add('text-red-600');
                checkoutMessage.textContent = 'Please log in to place an order.';
                return;
            }

            if (shoppingCart.length === 0) {
                checkoutMessage.classList.add('text-red-600');
                checkoutMessage.textContent = 'Your cart is empty. Cannot place an empty order.';
                return;
            }

            const orderDetails = {
                userId: window.currentUserId,
                customerName: customerName.value,
                customerAddress: customerAddress.value,
                items: shoppingCart.map(item => ({
                    productId: item.id,
                    name: item.name,
                    quantity: item.quantity,
                    price: item.price,
                    imageUrl: item.imageUrl
                })),
                total: shoppingCart.reduce((sum, item) => sum + item.price * item.quantity, 0),
                paymentMethod: document.querySelector('input[name="paymentMethod"]:checked').value,
                orderDate: new Date(),
                status: 'Pending'
            };

            try {
                // Add order to 'orders' collection
                await window.addDoc(ordersRef, orderDetails);

                // Clear the user's cart in Firestore
                shoppingCart = []; // Clear local cart
                await saveCart(); // Save empty cart to Firestore

                updateCartUI(); // Update UI to reflect empty cart
                checkoutForm.reset(); // Clear form fields

                checkoutMessage.classList.remove('text-gray-700');
                checkoutMessage.classList.add('text-green-600');
                checkoutMessage.textContent = 'Order placed successfully! Thank you for your purchase.';

                // Optionally, hide the modal after a short delay
                setTimeout(() => {
                    checkoutModal.classList.add('hidden');
                }, 3000);

            } catch (error) {
                console.error("Error placing order:", error);
                checkoutMessage.classList.remove('text-gray-700');
                checkoutMessage.classList.add('text-red-600');
                checkoutMessage.textContent = 'Failed to place order. Please try again.';
            }
        });

        loginSignupBtn.addEventListener('click', () => openAuthModal('login'));
        logoutBtn.addEventListener('click', async () => {
            try {
                await window.signOut(window.auth);
                alert('You have been logged out.');
                // Firebase onAuthStateChanged will handle UI updates and cart clearing
            } catch (error) {
                console.error("Error signing out:", error);
                alert('Failed to log out. Please try again.');
            }
        });

        toggleAuthModeBtn.addEventListener('click', () => {
            authMode = authMode === 'login' ? 'signup' : 'login';
            openAuthModal(authMode); // Re-open modal with new mode
        });

        authForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = authEmail.value;
            const password = authPassword.value;
            authError.classList.add('hidden'); // Hide previous errors

            if (authMode === 'signup') {
                try {
                    await window.createUserWithEmailAndPassword(window.auth, email, password);
                    authModal.classList.add('hidden');
                    alert('Account created and logged in successfully!');
                    // onAuthStateChanged will handle subsequent UI updates and cart loading
                } catch (error) {
                    console.error("Signup error:", error);
                    let errorMessage = "Failed to sign up. Please try again.";
                    if (error.code === 'auth/email-already-in-use') {
                        errorMessage = 'This email is already in use. Please login instead.';
                    } else if (error.code === 'auth/weak-password') {
                        errorMessage = 'Password should be at least 6 characters.';
                    }
                    authError.textContent = errorMessage;
                    authError.classList.remove('hidden');
                }
            } else { // Login mode
                try {
                    await window.signInWithEmailAndPassword(window.auth, email, password);
                    authModal.classList.add('hidden');
                    alert('Logged in successfully!');
                    // onAuthStateChanged will handle subsequent UI updates and cart loading
                } catch (error) {
                    console.error("Login error:", error);
                    let errorMessage = "Invalid email or password. Please try again.";
                    if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
                        errorMessage = 'Invalid email or password.';
                    }
                    authError.textContent = errorMessage;
                    authError.classList.remove('hidden');
                }
            }
        });

        homeLink.addEventListener('click', (e) => {
            e.preventDefault();
            productDetailModal.classList.add('hidden');
            cartModal.classList.add('hidden');
            checkoutModal.classList.add('hidden');
            authModal.classList.add('hidden');
            // Reset filters if any
            document.querySelector('.category-btn[data-category="all"]').click();
        });


        // Function to update Login/Logout buttons based on auth state
        const updateAuthStateUI = (user) => {
            if (user && !user.isAnonymous) { // User is logged in with email/password or custom token
                loginSignupBtn.classList.add('hidden');
                logoutBtn.classList.remove('hidden');
                authStatus.textContent = `Logged in as: ${user.email || 'User'}`;
            } else { // User is anonymous or logged out
                loginSignupBtn.classList.remove('hidden');
                logoutBtn.classList.add('hidden');
                authStatus.textContent = "Ready to shop! (Guest Mode)";
            }
        };

    </script>
</body>
</html>