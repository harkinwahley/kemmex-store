<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Kemmex Admin â€“ Orders</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
</head>

<body class="bg-gray-100 p-6 font-sans">

  <div class="max-w-7xl mx-auto bg-white shadow-lg rounded-lg p-6">
    <div class="flex justify-between items-center mb-6">
        <h1 class="text-2xl font-bold text-gray-800">Kemmex Orders Dashboard</h1>
        <button onclick="logout()" class="text-red-500 hover:text-red-700 font-bold text-sm">
            <i class="fas fa-sign-out-alt"></i> Logout
        </button>
    </div>

    <div class="overflow-x-auto">
        <table class="w-full text-sm border-collapse">
        <thead class="bg-gray-50 text-left">
            <tr>
            <th class="border p-3 text-gray-600">Date</th>
            <th class="border p-3 text-gray-600">Customer</th>
            <th class="border p-3 text-gray-600">Items</th>
            <th class="border p-3 text-gray-600">Total</th>
            <th class="border p-3 text-gray-600">Status</th>
            <th class="border p-3 text-gray-600">Update Action</th>
            </tr>
        </thead>
        <tbody id="ordersTable" class="bg-white">
            <tr>
                <td colspan="6" class="p-4 text-center text-gray-500">Loading orders...</td>
            </tr>
        </tbody>
        </table>
    </div>
  </div>

  <script>
    // ==========================================
    // âš™ï¸ CONFIGURATION SECTION (EDIT HERE ONLY)
    // ==========================================

    // 1. ADMIN SETUP
    const ADMIN_EMAILS = ["aakinwale16@gmail.com"]; 

    // 2. EMAILJS KEYS (Get these from emailjs.com)
    const EMAILJS_PUBLIC_KEY = "WsjcWcIMjnLefjP2o";  // e.g. "user_..."
    const EMAILJS_SERVICE_ID = "service_mn2qs7h";  // e.g. "service_..."
    const EMAILJS_TEMPLATE_ID = "template_majk5sn"; // e.g. "template_..."

    // 3. FIREBASE CONFIG
    const firebaseConfig = {
      apiKey: "AIzaSyBizDI5d10EjKw3TREi84gvmsC5uGcRxh8",
      authDomain: "kemmex-store-9ffa3.firebaseapp.com",
      projectId: "kemmex-store-9ffa3",
      storageBucket: "kemmex-store-9ffa3.firebasestorage.app",
      messagingSenderId: "500875032118",
      appId: "1:500875032118:web:f1d3b9b9d6351bc7130a97"
    };

    // ==========================================
    // ðŸš€ END CONFIGURATION (DO NOT EDIT BELOW)
    // ==========================================

    // Initialize Services
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    
    // Initialize EmailJS immediately
    (function(){
      if(EMAILJS_PUBLIC_KEY !== "YOUR_PUBLIC_KEY") {
          emailjs.init(EMAILJS_PUBLIC_KEY);
      }
    })();

    // --- AUTH CHECK ---
    auth.onAuthStateChanged(user => {
      if (!user) {
        window.location.href = "index.html"; 
        return;
      }
      
      if (!ADMIN_EMAILS.includes(user.email)) {
        alert("Unauthorized access! You are not an admin.");
        auth.signOut();
        window.location.href = "index.html";
        return;
      }

      loadOrders();
    });

    // --- LOAD ORDERS ---
    function loadOrders() {
      db.collection("orders")
        .orderBy("createdAt", "desc")
        .onSnapshot(snapshot => {
          const table = document.getElementById("ordersTable");
          
          if (snapshot.empty) {
              table.innerHTML = `<tr><td colspan="6" class="p-4 text-center text-gray-500">No orders found.</td></tr>`;
              return;
          }

          table.innerHTML = ""; 

          snapshot.forEach(doc => {
            const order = doc.data();
            const date = order.createdAt ? new Date(order.createdAt.seconds * 1000).toLocaleDateString() : 'Just now';

            // Status Badge Color logic
            let statusColor = "bg-gray-100 text-gray-800";
            if(order.status === 'confirmed') statusColor = "bg-blue-100 text-blue-800";
            if(order.status === 'processing') statusColor = "bg-yellow-100 text-yellow-800";
            if(order.status === 'shipped') statusColor = "bg-purple-100 text-purple-800";
            if(order.status === 'delivered') statusColor = "bg-green-100 text-green-800";

            table.innerHTML += `
              <tr class="hover:bg-gray-50 transition">
                <td class="border p-3 whitespace-nowrap text-gray-500 text-xs">${date}</td>
                <td class="border p-3">
                  <div class="font-bold text-gray-800 text-sm">${order.customer.firstName} ${order.customer.lastName}</div>
                  <div class="text-xs text-gray-500">${order.customer.phone}</div>
                  <div class="text-xs text-gray-400 italic">${order.customer.address}</div>
                </td>
                <td class="border p-3">
                  <ul class="list-disc list-inside text-gray-700 text-sm">
                    ${order.items.map(i => `<li>${i.name} <span class="text-gray-400 text-xs">x${i.qty}</span></li>`).join("")}
                  </ul>
                </td>
                <td class="border p-3 font-bold text-gray-800 text-sm">
                  â‚¦${order.totalAmount.toLocaleString()}
                </td>
                <td class="border p-3">
                  <span class="px-2 py-1 rounded-full text-[10px] font-bold uppercase ${statusColor}">
                    ${order.status}
                  </span>
                </td>
                <td class="border p-3">
                  <select onchange="updateStatus('${doc.id}', this.value, '${order.email}', '${order.customer.firstName}')" 
                    class="border border-gray-300 rounded px-2 py-1 text-xs outline-none focus:border-blue-500 cursor-pointer bg-white">
                    <option value="pending" ${order.status === "pending" ? "selected" : ""}>Pending</option>
                    <option value="confirmed" ${order.status === "confirmed" ? "selected" : ""}>Confirmed</option>
                    <option value="processing" ${order.status === "processing" ? "selected" : ""}>Processing</option>
                    <option value="shipped" ${order.status === "shipped" ? "selected" : ""}>Shipped</option>
                    <option value="delivered" ${order.status === "delivered" ? "selected" : ""}>Delivered</option>
                  </select>
                </td>
              </tr>
            `;
          });
        });
    }

    // --- UPDATE STATUS & SEND EMAIL ---
    function updateStatus(orderId, status, customerEmail, customerName) {
      if(!confirm(`Update status to "${status}"?`)) return;

      // 1. Update Firestore
      db.collection("orders").doc(orderId).update({
        status: status,
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      })
      .then(() => {
          alert(`Order updated to ${status}`);
          
          // 2. Send Email (Only if keys are configured)
          if (customerEmail && EMAILJS_PUBLIC_KEY !== "YOUR_PUBLIC_KEY") {
             sendEmail(customerEmail, customerName, status, orderId);
          }
      })
      .catch(err => alert("Error: " + err.message));
    }

    function sendEmail(email, name, status, orderId) {
        const params = {
            to_email: email,
            to_name: name,
            order_status: status,
            order_id: orderId
        };

        emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, params)
            .then(res => console.log("Email sent!", res.status, res.text))
            .catch(err => console.error("Email failed:", err));
    }

    function logout() {
        auth.signOut().then(() => window.location.href = "index.html");
    }
  </script>

</body>
</html>
